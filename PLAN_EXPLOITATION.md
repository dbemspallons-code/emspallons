# Plan d'exploitation

Date: 2026-02-05

## 1. Objectifs

- Disponibilite stable (frontend + API functions).
- Integrite des donnees (scans, abonnements, paiements).
- Securite (RLS, gestion des secrets, controle des acces).
- Traçabilite (logs, audit, historique).

## 2. Perimetre technique

- Frontend: `web-pwa/` (Vite + React)
- Functions: `netlify/functions/`
- Base: Supabase (Postgres + RLS)
- Deploiement: Netlify (prod)

## 3. Roles et responsabilites

- **Admin**: gestion des utilisateurs, classes, promos, annonces.
- **Controleur**: scan et validation sur terrain.
- **Operateur**: suivi paiements et abonnements.
- **Technique**: deploiements, logs, incidents, sauvegardes.

## 4. Supervision et monitoring

Quotidien:
- Verifier les deploiements Netlify et les logs functions.
- Verifier les erreurs JS en prod (console + logs).

Hebdomadaire:
- Controler les volumes `scan_logs` et `payments`.
- Verifier que les policies RLS n'ont pas ete modifiees.

Mensuel:
- Revue des erreurs recurrentes.
- Point performance (taille bundles, temps de chargement).

## 5. Sauvegardes et reprise

- Activer les **backups automatiques** Supabase si disponibles dans le plan.
- Export manuel mensuel des tables critiques:
  - `scan_logs`, `payments`, `subscription_history`, `system_history`
- Documenter la procedure de restauration (export/import).

## 6. Gestion des secrets et securite

Rotation recommandee (mensuelle ou apres incident):
- `SUPABASE_SERVICE_KEY`
- `NETLIFY_AUTH_TOKEN`
- `SCHEDULED_JOB_SECRET` (si utilise)

Bonnes pratiques:
- Ne jamais committer les secrets dans Git.
- Stocker les secrets uniquement dans Netlify (env vars).
- Limiter les droits du service role aux fonctions serveur.

## 7. Processus de deploiement

1. Branche de travail / test local.
2. `npm run build` dans `web-pwa/`.
3. `netlify deploy --prod` (ou script `scripts/deploy-netlify.ps1`).
4. Verification post-deploiement:
   - Acces front
   - Functions `verify-qr-token` et `log-scan`
5. Mise a jour du changelog interne (si besoin).

## 8. Gestion des incidents

Priorites:
1. Indisponibilite du site
2. Erreurs de scan / paiement
3. Degradation performance

Procedure:
- Identifier l'etape qui casse (frontend / functions / supabase).
- Verifier logs Netlify functions.
- Verifier requetes Supabase et RLS.
- Revenir au dernier deploy stable si necessaire.

## 9. Controle d'acces et RLS

Regles en place:
- `Classes`, `Controleurs`, `Bandes-annonces`: CRUD authentifie.
- `qr_codes`, `scan_logs`, `school_photos`: policies restrintes (server-only ou auth).

Revue trimestrielle:
- Verifier que les policies correspondent au modele d'acces reel.
- Verifier les utilisateurs qui ont des droits eleves.

## 10. KPIs recommandés

- Taux d'erreur de scan (jour/semaine)
- Temps moyen de scan
- Nombre d'abonnements actifs
- Paiements en retard

## 11. Checklist exploitation (resume)

- Logs Netlify OK
- Build OK
- RLS OK
- Sauvegardes OK
- Secrets rotates si besoin

